{% extends "base.html" %}

{% block title %}Blog - Blog & Todo{% endblock %}

{% block content %}
<section class="section">
    <div class="columns">
        <div class="column is-10 is-offset-1">
            <h1 class="title page-title">‚úçÔ∏è My Blog</h1>
            
            <div class="card mb-5">
                <div class="card-content">
                    <h2 class="subtitle" id="formTitle">Write New Blog Post</h2>
                    <form method="POST" id="blogForm">
                        <input type="hidden" name="blog_id" id="blogId">
                        <div class="field">
                            <label class="label">Title</label>
                            <div class="control">
                                <input class="input" type="text" name="title" id="blogTitle" placeholder="Blog title" required>
                            </div>
                        </div>

                        <div class="field">
                            <label class="label">Content</label>
                            <div class="notification is-info is-light mb-3">
                                <p class="is-size-7">
                                    <strong>Quick Formatting Tip:</strong> Type <code>**text**</code> to make text bold
                                </p>
                            </div>
                            <div id="blogContent" contenteditable="true"></div>
                            <input type="hidden" name="content" id="contentInput">
                        </div>

                        <div class="field is-grouped">
                            <div class="control">
                                <button class="button is-success" type="submit">
                                    <span class="icon"><i class="fas fa-paper-plane"></i></span>
                                    <span id="submitBtnText">Publish Blog</span>
                                </button>
                            </div>
                            <div class="control" id="cancelBtnContainer" style="display: none;">
                                <button class="button is-light" type="button" onclick="cancelEdit()">
                                    <span class="icon"><i class="fas fa-times"></i></span>
                                    <span>Cancel</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="columns is-vcentered mb-4">
                <div class="column">
                    <h2 class="title page-title is-inline">üìö My Blog Posts</h2>
                </div>
                <div class="column is-narrow">
                    <div class="field has-addons">
                        <div class="control">
                            <input type="date" class="input" id="blogDatePicker" value="{{ selected_date }}" onchange="changeBlogDate()">
                        </div>
                        <div class="control">
                            <button class="button is-info" onclick="document.getElementById('blogDatePicker').showPicker()">
                                <span class="icon"><i class="fas fa-calendar"></i></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% if blogs %}
                {% for blog in blogs %}
                <div class="card mb-3 blog-list-item">
                    <div class="card-content">
                        <div class="columns is-vcentered is-mobile">
                            <div class="column">
                                <h3 class="title is-5 mb-2">{{ blog.title }}</h3>
                                <div class="blog-meta-compact">
                                    <span class="icon-text">
                                        <span class="icon"><i class="fas fa-calendar"></i></span>
                                        <span>{{ blog.blog_date }}</span>
                                    </span>
                                    <span class="mx-2">‚Ä¢</span>
                                    <span class="icon-text">
                                        <span class="icon"><i class="fas fa-clock"></i></span>
                                        <span>{{ blog.created_at }}</span>
                                    </span>
                                    {% if blog.updated_at %}
                                    <span class="mx-2">‚Ä¢</span>
                                    <span class="icon-text">
                                        <span class="icon"><i class="fas fa-edit"></i></span>
                                        <span>Updated: {{ blog.updated_at }}</span>
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="column is-narrow">
                                <div class="buttons">
                                    <button class="button is-small is-info is-light" onclick="previewBlog({{ blog.id }})">
                                        <span class="icon"><i class="fas fa-eye"></i></span>
                                        <span>Preview</span>
                                    </button>
                                    <button class="button is-small is-warning is-light" onclick="editBlog({{ blog.id }})">
                                        <span class="icon"><i class="fas fa-edit"></i></span>
                                        <span>Edit</span>
                                    </button>
                                    <a href="{{ url_for('delete_blog', id=blog.id) }}" class="button is-small is-danger is-light" onclick="return confirm('Are you sure you want to delete this blog?')">
                                        <span class="icon"><i class="fas fa-trash"></i></span>
                                        <span>Delete</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="card">
                    <div class="card-content has-text-centered">
                        <p class="has-text-grey">No blog posts for {{ selected_date }}. Write your first blog above!</p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- Preview Modal -->
<div class="modal" id="previewModal">
    <div class="modal-background" onclick="closePreviewModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title" id="previewTitle"></p>
            <button class="delete" aria-label="close" onclick="closePreviewModal()"></button>
        </header>
        <section class="modal-card-body">
            <div class="blog-content" id="previewContent"></div>
        </section>
        <footer class="modal-card-foot">
            <button class="button" onclick="closePreviewModal()">Close</button>
        </footer>
    </div>
</div>

<script>
    const blogContent = document.getElementById('blogContent');
    const contentInput = document.getElementById('contentInput');
    const blogForm = document.getElementById('blogForm');
    const blogIdInput = document.getElementById('blogId');
    const blogTitleInput = document.getElementById('blogTitle');
    const formTitle = document.getElementById('formTitle');
    const submitBtnText = document.getElementById('submitBtnText');
    const cancelBtnContainer = document.getElementById('cancelBtnContainer');

    blogForm.addEventListener('submit', function(e) {
        // Get the innerHTML and convert markdown bold to HTML
        const rawContent = blogContent.innerHTML;
        contentInput.value = convertMarkdownToHTML(rawContent);
    });

    function convertMarkdownToHTML(text) {
        let html = text;
        
        // Convert bold **text** to <strong>
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        
        return html;
    }

    function convertHTMLToMarkdown(html) {
        let text = html;
        
        // Convert <strong> back to **text**
        text = text.replace(/<strong>(.+?)<\/strong>/gi, '**$1**');
        
        return text;
    }

    // Handle Enter key to create new lines
    blogContent.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const selection = window.getSelection();
            const range = selection.getRangeAt(0);
            
            // Insert line break
            const br = document.createElement('br');
            range.insertNode(br);
            
            // Move cursor after the break
            range.setStartAfter(br);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            
            // Insert another br for spacing
            const br2 = document.createElement('br');
            range.insertNode(br2);
            range.setStartAfter(br2);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
        }
    });

    blogContent.addEventListener('paste', function(e) {
        e.preventDefault();
        const text = e.clipboardData.getData('text/plain');
        document.execCommand('insertText', false, text);
    });

    async function editBlog(id) {
        try {
            const response = await fetch(`/blog/get/${id}`);
            const blog = await response.json();
            
            blogIdInput.value = blog.id;
            blogTitleInput.value = blog.title;
            
            // Convert HTML back to markdown for editing
            const markdownContent = convertHTMLToMarkdown(blog.content);
            blogContent.innerHTML = markdownContent;
            
            formTitle.textContent = 'Edit Blog Post';
            submitBtnText.textContent = 'Update Blog';
            cancelBtnContainer.style.display = 'block';
            
            // Scroll to form
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
            console.error('Error loading blog:', error);
        }
    }

    function cancelEdit() {
        blogIdInput.value = '';
        blogTitleInput.value = '';
        blogContent.innerHTML = '';
        formTitle.textContent = 'Write New Blog Post';
        submitBtnText.textContent = 'Publish Blog';
        cancelBtnContainer.style.display = 'none';
    }

    async function previewBlog(id) {
        try {
            const response = await fetch(`/blog/get/${id}`);
            const blog = await response.json();
            
            document.getElementById('previewTitle').textContent = blog.title;
            document.getElementById('previewContent').innerHTML = blog.content;
            
            document.getElementById('previewModal').classList.add('is-active');
            document.documentElement.classList.add('is-clipped');
        } catch (error) {
            console.error('Error loading blog preview:', error);
        }
    }

    function closePreviewModal() {
        document.getElementById('previewModal').classList.remove('is-active');
        document.documentElement.classList.remove('is-clipped');
    }

    function changeBlogDate() {
        const selectedDate = document.getElementById('blogDatePicker').value;
        window.location.href = `/blog?date=${selectedDate}`;
    }
</script>
{% endblock %}
